'use client';

import { useEffect, useRef, useState } from 'react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { ScrollArea } from '@/components/ui/scroll-area';
import { SelectableText } from './SelectableText';
import type { MessageAnalysis } from '@/stores/chatStore';
import { ttsManager } from '@/lib/tts/manager';

interface MessageAnalysisPopupProps {
  analysis: MessageAnalysis;
  className?: string;
}

export function MessageAnalysisPopup({ analysis, className = '' }: MessageAnalysisPopupProps) {
  // CURSOR: Defensive defaults for potentially undefined fields
  const grammarErrors = analysis.grammarErrors ?? [];
  const vocabularySuggestions = analysis.vocabularySuggestions ?? [];
  const alternativePhrasings = analysis.alternativePhrasings ?? [];
  const grammarScore = analysis.grammarScore ?? 70;
  const vocabularyScore = analysis.vocabularyScore ?? 70;
  const relevanceScore = analysis.relevanceScore ?? 80;
  const relevanceFeedback = analysis.relevanceFeedback;
  const fluencyScore = analysis.fluencyScore ?? 70;
  const overallFeedback = analysis.overallFeedback ?? 'Analysis complete.';
  const pronunciation = analysis.pronunciation;
  const pronunciationScore = pronunciation?.pronunciationScore ?? null;
  const mispronunciations = pronunciation?.mispronunciations ?? [];
  const pronunciationFeedback = pronunciation?.pronunciationFeedback ?? '';

  const [playingKey, setPlayingKey] = useState<string | null>(null);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  useEffect(() => {
    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  const stopPronunciationAudio = () => {
    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current = null;
    }
    setPlayingKey(null);
  };

  const playPronunciation = async (text: string, key: string) => {
    stopPronunciationAudio();
    setPlayingKey(key);
    try {
      const audioData = await ttsManager.synthesize(text);
      const blob = new Blob([audioData], { type: 'audio/wav' });
      const audioUrl = URL.createObjectURL(blob);
      const audio = new Audio(audioUrl);
      audioRef.current = audio;
      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        if (audioRef.current === audio) {
          audioRef.current = null;
        }
        setPlayingKey(null);
      };
      audio.onerror = () => {
        URL.revokeObjectURL(audioUrl);
        if (audioRef.current === audio) {
          audioRef.current = null;
        }
        setPlayingKey(null);
      };
      await audio.play();
    } catch (error) {
      console.error('Pronunciation playback failed:', error);
      setPlayingKey(null);
    }
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'bg-green-500';
    if (score >= 60) return 'bg-yellow-500';
    return 'bg-red-500';
  };

  const getScoreLabel = (score: number) => {
    if (score >= 90) return 'Excellent';
    if (score >= 80) return 'Great';
    if (score >= 70) return 'Good';
    if (score >= 60) return 'Fair';
    return 'Needs Work';
  };

  const averageScore = Math.round(
    (grammarScore + vocabularyScore + relevanceScore + fluencyScore) / 4
  );

  return (
    <div className={`w-full overflow-hidden ${className}`}>
      <div className="p-4 pb-2 border-b bg-background">
        <div className="flex items-center justify-between">
          <span className="font-semibold">Message Analysis</span>
          <Badge variant="secondary" className="text-lg">
            {averageScore}/100
          </Badge>
        </div>
      </div>
      
      <ScrollArea className="h-[400px]">
        <div className="p-4 pb-12">
          {/* Score Overview */}
          <div className="grid grid-cols-2 gap-3 mb-4">
            <ScoreCard
              label="Grammar"
              score={grammarScore}
              color={getScoreColor(grammarScore)}
            />
            <ScoreCard
              label="Vocabulary"
              score={vocabularyScore}
              color={getScoreColor(vocabularyScore)}
            />
            <ScoreCard
              label="Relevance"
              score={relevanceScore}
              color={getScoreColor(relevanceScore)}
            />
            <ScoreCard
              label="Fluency"
              score={fluencyScore}
              color={getScoreColor(fluencyScore)}
            />
          </div>

          {/* CURSOR: Show relevance feedback when score is low or feedback exists */}
          {(relevanceScore < 60 || relevanceFeedback) && (
            <div className="mb-4">
              <Separator className="my-4" />
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <span className={`w-5 h-5 rounded-full ${relevanceScore < 60 ? 'bg-orange-500' : 'bg-blue-500'} text-white text-xs flex items-center justify-center`}>?</span>
                <span>Context Relevance</span>
              </h4>
              {relevanceFeedback ? (
                <SelectableText text={relevanceFeedback} className="text-sm text-muted-foreground" />
              ) : relevanceScore < 60 ? (
                <p className="text-sm text-muted-foreground">
                  Your response may not have been directly related to the previous question or topic. 
                  Try to address what was asked before changing the subject.
                </p>
              ) : null}
            </div>
          )}

          {/* Grammar Errors */}
          {grammarErrors.length > 0 && (
            <div className="mb-4">
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <span className="w-5 h-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center">!</span>
                <span>Grammar Corrections</span>
              </h4>
              <div className="space-y-2">
                {grammarErrors.map((error, index) => (
                  <div key={index} className="p-3 bg-muted rounded-lg">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="line-through text-muted-foreground">{error.original}</span>
                      <span className="text-green-600">-&gt;</span>
                      <span className="font-medium text-green-600">{error.correction}</span>
                    </div>
                    <SelectableText text={error.explanation} className="text-sm text-muted-foreground" />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Vocabulary Suggestions - tips on how to improve word choice */}
          {vocabularySuggestions.length > 0 && (
            <div className="mb-4">
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <span className="w-5 h-5 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center">i</span>
                <span>How to Improve Your Vocabulary</span>
              </h4>
              <ul className="space-y-2 text-sm text-muted-foreground">
                {vocabularySuggestions.map((suggestion, index) => (
                  <li key={index} className="p-2 bg-blue-50 dark:bg-blue-950/20 rounded">
                    <SelectableText text={suggestion} />
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Alternative Phrasings - other ways to say the same thing in the learning language */}
          {alternativePhrasings.length > 0 && (
            <div className="mb-4">
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <span className="w-5 h-5 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center">+</span>
                <span>Other Ways to Say This</span>
              </h4>
              <div className="space-y-2">
                {alternativePhrasings.map((phrase, index) => (
                  <div key={index} className="p-2 bg-purple-50 dark:bg-purple-950/20 rounded border border-purple-200 dark:border-purple-800">
                    <SelectableText text={phrase} className="text-sm italic" />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* CURSOR: Pronunciation Feedback */}
          {pronunciation && (
            <div className="mb-4">
              <Separator className="my-4" />
              <h4 className="font-semibold mb-2 flex items-center gap-2">
                <span className="w-5 h-5 rounded-full bg-indigo-500 text-white text-xs flex items-center justify-center">P</span>
                <span>Pronunciation</span>
              </h4>
              {pronunciationScore !== null && (
                <div className="mb-3">
                  <ScoreCard
                    label="Pronunciation"
                    score={pronunciationScore}
                    color={getScoreColor(pronunciationScore)}
                  />
                </div>
              )}
              {pronunciation.transcribedText && (
                <p className="text-sm text-muted-foreground mb-3">
                  Heard: {pronunciation.transcribedText}
                </p>
              )}
              {mispronunciations.length > 0 ? (
                <div className="space-y-2">
                  {mispronunciations.map((item, index) => {
                    const key = `${item.word}-${index}`;
                    return (
                      <div key={key} className="p-3 bg-muted rounded-lg">
                        <div className="flex items-center justify-between gap-3">
                          <div className="text-sm">
                            <div className="flex items-center gap-2">
                              <span className="font-medium">{item.word || 'Unknown'}</span>
                              <span className="text-muted-foreground">heard as</span>
                              <span className="text-muted-foreground">{item.heardAs || '-'}</span>
                            </div>
                            {item.correctPronunciation && (
                              <div className="text-xs text-muted-foreground">
                                Pronunciation: {item.correctPronunciation}
                              </div>
                            )}
                          </div>
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => playPronunciation(item.word || '', key)}
                            disabled={!item.word || playingKey === key}
                          >
                            {playingKey === key ? 'Playing...' : 'Play'}
                          </Button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">No clear mispronunciations detected.</p>
              )}
              {pronunciationFeedback && (
                <SelectableText text={pronunciationFeedback} className="text-sm text-muted-foreground mt-3" />
              )}
            </div>
          )}

          {/* Overall Feedback - Always show */}
          <div className="pt-4 mt-4 border-t">
            <h4 className="font-semibold mb-2 flex items-center gap-2">
              <span className="w-5 h-5 rounded-full bg-green-500 text-white text-xs flex items-center justify-center">*</span>
              <span>{getScoreLabel(averageScore)}!</span>
            </h4>
            <SelectableText text={overallFeedback} className="text-sm text-muted-foreground" />
          </div>
        </div>
      </ScrollArea>
    </div>
  );
}

function ScoreCard({ label, score, color }: { label: string; score: number; color: string }) {
  return (
    <div className="p-3 bg-muted rounded-lg">
      <div className="flex justify-between items-center mb-1">
        <span className="text-sm font-medium">{label}</span>
        <span className="text-sm font-bold">{score}</span>
      </div>
      <div className="h-2 bg-background rounded-full overflow-hidden">
        <div
          className={`h-full transition-all duration-500 ${color}`}
          style={{ width: `${score}%` }}
        />
      </div>
    </div>
  );
}
