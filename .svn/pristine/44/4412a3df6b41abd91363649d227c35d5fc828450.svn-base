'use client';

import { useState, useCallback } from 'react';
import { TranslationPopup } from './TranslationPopup';

// CURSOR: SelectableText - Allows users to select words/phrases for translation
// Wraps message content and handles text selection

interface SelectableTextProps {
  text: string;
  chatId?: string;
  className?: string;
}

export function SelectableText({ text, chatId, className = '' }: SelectableTextProps) {
  const [selectedText, setSelectedText] = useState<string | null>(null);
  const [popoverPosition, setPopoverPosition] = useState<{ x: number; y: number } | null>(null);

  const handleMouseUp = useCallback(() => {
    const selection = window.getSelection();
    const selected = selection?.toString().trim();
    
    if (selected && selected.length > 0 && selected.length < 200) {
      setSelectedText(selected);
      
      // Get selection position for popover
      const range = selection?.getRangeAt(0);
      if (range) {
        const rect = range.getBoundingClientRect();
        setPopoverPosition({
          x: rect.left + rect.width / 2,
          y: rect.top,
        });
      }
    } else {
      setSelectedText(null);
      setPopoverPosition(null);
    }
  }, []);

  const handleClick = useCallback(() => {
    // Clear selection on click elsewhere
    setTimeout(() => {
      const selection = window.getSelection();
      if (!selection?.toString().trim()) {
        setSelectedText(null);
        setPopoverPosition(null);
      }
    }, 100);
  }, []);

  return (
    <div className={`relative ${className}`}>
      <p 
        className="whitespace-pre-wrap cursor-text select-text"
        onMouseUp={handleMouseUp}
        onClick={handleClick}
      >
        {text}
      </p>
      
      {/* Translation popup for selected text */}
      {selectedText && popoverPosition && (
        <div 
          className="fixed z-50"
          style={{ 
            left: popoverPosition.x, 
            top: popoverPosition.y - 10,
            transform: 'translate(-50%, -100%)',
          }}
        >
          <TranslationPopup 
            text={selectedText} 
            chatId={chatId}
            onSaveToVocabulary={() => {
              setSelectedText(null);
              setPopoverPosition(null);
            }}
          >
            <button className="px-3 py-1.5 bg-primary text-primary-foreground rounded-lg shadow-lg text-sm font-medium hover:bg-primary/90 transition-colors">
              Translate
            </button>
          </TranslationPopup>
        </div>
      )}
    </div>
  );
}
