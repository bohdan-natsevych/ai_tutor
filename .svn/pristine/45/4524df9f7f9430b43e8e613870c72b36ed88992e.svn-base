import { create } from 'zustand';

// Message state types
export type MessageState = 
  | 'generating'    // AI is generating response
  | 'audio_loading' // TTS is converting text to audio
  | 'playing'       // Audio is playing, text hidden
  | 'revealed';     // Audio finished, text visible

export interface ChatMessage {
  id: string;
  chatId: string;
  role: 'user' | 'assistant';
  content: string;
  state: MessageState;
  audioUrl?: string;
  audioPlayed: boolean;
  analysis?: MessageAnalysis;
  createdAt: Date;
}

export interface MessageAnalysis {
  grammarScore: number;
  grammarErrors: Array<{
    original: string;
    correction: string;
    explanation: string;
  }>;
  vocabularyScore: number;
  vocabularySuggestions: string[];
  relevanceScore: number;
  fluencyScore: number;
  overallFeedback: string;
  alternativePhrasings: string[];
}

export interface Chat {
  id: string;
  title: string;
  topicType: 'general' | 'roleplay' | 'topic';
  topicKey?: string;
  topicDetails?: Record<string, unknown>;
  language: string;
  dialect: string;
  threadId?: string;
  aiProvider: string;
  aiMode: 'chat' | 'assistant';
  createdAt: Date;
  updatedAt: Date;
}

interface ChatState {
  // Current chat state
  currentChat: Chat | null;
  messages: ChatMessage[];
  isLoading: boolean;
  error: string | null;
  
  // Recording state
  isRecording: boolean;
  transcript: string;
  
  // Playback state
  currentlyPlayingId: string | null;
  
  // Actions
  setCurrentChat: (chat: Chat | null) => void;
  setMessages: (messages: ChatMessage[]) => void;
  addMessage: (message: ChatMessage) => void;
  updateMessage: (id: string, updates: Partial<ChatMessage>) => void;
  removeMessage: (id: string) => void;
  
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  
  setRecording: (recording: boolean) => void;
  setTranscript: (transcript: string) => void;
  
  setCurrentlyPlaying: (messageId: string | null) => void;
  
  reset: () => void;
}

const initialState = {
  currentChat: null,
  messages: [],
  isLoading: false,
  error: null,
  isRecording: false,
  transcript: '',
  currentlyPlayingId: null,
};

export const useChatStore = create<ChatState>((set) => ({
  ...initialState,

  setCurrentChat: (chat) => set({ currentChat: chat }),
  
  setMessages: (messages) => set({ messages }),
  
  addMessage: (message) =>
    set((state) => ({
      messages: [...state.messages, message],
    })),
  
  updateMessage: (id, updates) =>
    set((state) => ({
      messages: state.messages.map((msg) =>
        msg.id === id ? { ...msg, ...updates } : msg
      ),
    })),
  
  removeMessage: (id) =>
    set((state) => ({
      messages: state.messages.filter((msg) => msg.id !== id),
    })),
  
  setLoading: (isLoading) => set({ isLoading }),
  
  setError: (error) => set({ error }),
  
  setRecording: (isRecording) => set({ isRecording }),
  
  setTranscript: (transcript) => set({ transcript }),
  
  setCurrentlyPlaying: (messageId) => set({ currentlyPlayingId: messageId }),
  
  reset: () => set(initialState),
}));
