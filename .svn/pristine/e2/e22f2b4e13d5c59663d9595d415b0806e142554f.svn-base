'use client';

import { useState } from 'react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { MessageAnalysisPopup } from './MessageAnalysis';
import { SelectableText } from './SelectableText';
import type { ChatMessage } from '@/stores/chatStore';
import { useSettingsStore } from '@/stores/settingsStore';

interface ChatMessageProps {
  message: ChatMessage;
  onReplay?: () => void;  // CURSOR: Regenerate and play audio
  onAnalyze?: () => void;
  isPlaying?: boolean;
  className?: string;
}

export function ChatMessageBubble({
  message,
  onReplay,
  onAnalyze,
  isPlaying = false,
  className = '',
}: ChatMessageProps) {
  const [showAnalysis, setShowAnalysis] = useState(false);
  const [showTranslation, setShowTranslation] = useState(false);
  const [fullTranslation, setFullTranslation] = useState<string | null>(null);
  const [isTranslating, setIsTranslating] = useState(false);
  
  // CURSOR: Use selector for better performance
  const ui = useSettingsStore((state) => state.ui);
  const language = useSettingsStore((state) => state.language);
  
  const isUser = message.role === 'user';
  const isHidden = ui.listenFirstMode && 
    message.role === 'assistant' && 
    message.state === 'playing' && 
    !message.audioPlayed;

  // Determine what to show based on state
  const showLoader = message.state === 'generating' || message.state === 'audio_loading';
  const showContent = !isHidden && (message.state === 'revealed' || isUser);
  const showPlayButton = message.role === 'assistant' && 
    (message.state === 'revealed' || message.audioPlayed);

  // CURSOR: Fetch full message translation
  const handleTranslateMessage = async () => {
    if (fullTranslation) {
      setShowTranslation(!showTranslation);
      return;
    }
    
    setIsTranslating(true);
    try {
      const response = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: message.content,
          targetLanguage: language.mother,
          sourceLanguage: language.learning,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        setFullTranslation(data.translation.translatedText);
        setShowTranslation(true);
      }
    } catch (err) {
      console.error('Translation failed:', err);
    } finally {
      setIsTranslating(false);
    }
  };

  return (
    <div
      className={cn(
        'flex gap-3 max-w-[85%]',
        isUser ? 'ml-auto flex-row-reverse' : 'mr-auto',
        className
      )}
    >
      {/* Avatar */}
      <div
        className={cn(
          'w-8 h-8 rounded-full flex items-center justify-center text-white font-medium text-sm shrink-0',
          isUser ? 'bg-blue-500' : 'bg-gradient-to-br from-violet-500 to-purple-600'
        )}
      >
        {isUser ? 'U' : 'AI'}
      </div>

      {/* Message content */}
      <div className="flex flex-col gap-2">
        <div
          className={cn(
            'rounded-2xl px-4 py-3 shadow-sm',
            isUser
              ? 'bg-blue-500 text-white rounded-tr-none'
              : 'bg-muted rounded-tl-none'
          )}
        >
          {showLoader ? (
            <div className="flex items-center gap-2">
              <div className="flex gap-1">
                <span className="w-2 h-2 bg-current rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                <span className="w-2 h-2 bg-current rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                <span className="w-2 h-2 bg-current rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
              </div>
              <span className="text-sm opacity-70">
                {message.state === 'generating' ? 'Thinking...' : 'Preparing audio...'}
              </span>
            </div>
          ) : isHidden ? (
            <div className="flex items-center gap-2">
              <WaveformIcon className="w-5 h-5 animate-pulse" />
              <span className="text-sm">Listen to the message...</span>
            </div>
          ) : showContent ? (
            <>
              <SelectableText 
                text={message.content} 
                chatId={message.chatId}
              />
              {/* Full translation toggle */}
              {showTranslation && fullTranslation && (
                <div className="mt-2 pt-2 border-t border-current/20">
                  <p className="text-sm opacity-80 italic">{fullTranslation}</p>
                </div>
              )}
            </>
          ) : null}
        </div>

        {/* Actions */}
        <div className="flex items-center gap-2 flex-wrap">
          {/* Replay button for AI messages */}
          {message.role === 'assistant' && showPlayButton && (
            <Button
              variant="ghost"
              size="sm"
              onClick={onReplay}
              disabled={isPlaying}
              className="text-xs gap-1"
            >
              {isPlaying ? (
                <>
                  <span className="relative flex h-2 w-2">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" />
                    <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500" />
                  </span>
                  Playing...
                </>
              ) : (
                <>
                  <PlayIcon className="h-3 w-3" />
                  Replay
                </>
              )}
            </Button>
          )}

          {/* Translate button - available for all revealed messages */}
          {showContent && (
            <Button
              variant="ghost"
              size="sm"
              onClick={handleTranslateMessage}
              disabled={isTranslating}
              className="text-xs"
            >
              {isTranslating ? 'Translating...' : showTranslation ? 'Hide Translation' : 'Translate'}
            </Button>
          )}

          {/* Analyze button for user messages */}
          {isUser && message.state === 'revealed' && (
            <Popover open={showAnalysis} onOpenChange={setShowAnalysis}>
              <PopoverTrigger asChild>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    if (!message.analysis) {
                      onAnalyze?.();
                    }
                    setShowAnalysis(true);
                  }}
                  className="text-xs"
                >
                  Analyze
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-[380px] max-h-[450px] p-0 overflow-hidden" align="start" side="top">
                {message.analysis ? (
                  <MessageAnalysisPopup analysis={message.analysis} />
                ) : (
                  <div className="p-4 text-center text-sm text-muted-foreground">
                    Analyzing...
                  </div>
                )}
              </PopoverContent>
            </Popover>
          )}
        </div>

        {/* Timestamp */}
        <span className="text-xs text-muted-foreground">
          {formatTime(message.createdAt)}
        </span>
      </div>
    </div>
  );
}

function formatTime(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
  }).format(new Date(date));
}

function WaveformIcon({ className }: { className?: string }) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="currentColor"
      className={className}
    >
      <path d="M12 3v18m-4-6v6m8-14v14M4 10v4m16-6v8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </svg>
  );
}

function PlayIcon({ className }: { className?: string }) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="currentColor"
      className={className}
    >
      <path d="M8 5.14v14l11-7-11-7z" />
    </svg>
  );
}
