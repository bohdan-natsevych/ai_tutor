'use client';

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { useSettingsStore } from '@/stores/settingsStore';

const AI_PROVIDERS = [
  { 
    id: 'openai-chat', 
    name: 'OpenAI (Chat)', 
    description: 'Chat Completions API - We manage history', 
    type: 'cloud',
    modes: ['chat'],
  },
  { 
    id: 'openai-assistant', 
    name: 'OpenAI (Assistants)', 
    description: 'Assistants API - OpenAI manages history', 
    type: 'cloud',
    modes: ['assistant'],
  },
  { 
    id: 'ollama', 
    name: 'Ollama (Local)', 
    description: 'Local server - Free, requires Ollama installed', 
    type: 'local',
    modes: ['chat'],
  },
  { 
    id: 'webllm', 
    name: 'WebLLM (Browser)', 
    description: 'Runs in browser via WebGPU - Free, no server needed', 
    type: 'local',
    modes: ['chat'],
  },
];

const MODELS: Record<string, Array<{ id: string; name: string; description: string }>> = {
  'openai-chat': [
    { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Fast and affordable' },
    { id: 'gpt-4o', name: 'GPT-4o', description: 'Most capable' },
    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'High performance' },
    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Legacy, fast' },
  ],
  'openai-assistant': [
    { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Fast and affordable' },
    { id: 'gpt-4o', name: 'GPT-4o', description: 'Most capable' },
  ],
  'ollama': [
    { id: 'llama3.2', name: 'Llama 3.2', description: 'Latest Llama model' },
    { id: 'llama3.1', name: 'Llama 3.1', description: 'Previous Llama model' },
    { id: 'mistral', name: 'Mistral', description: 'Fast and capable' },
    { id: 'gemma2', name: 'Gemma 2', description: 'Google Gemma model' },
    { id: 'qwen2.5', name: 'Qwen 2.5', description: 'Alibaba Qwen model' },
  ],
  'webllm': [
    { id: 'Llama-3.2-1B-Instruct-q4f32_1-MLC', name: 'Llama 3.2 1B', description: 'Tiny, fast (~500MB)' },
    { id: 'Llama-3.2-3B-Instruct-q4f32_1-MLC', name: 'Llama 3.2 3B', description: 'Small, balanced (~1.5GB)' },
    { id: 'Qwen2.5-1.5B-Instruct-q4f32_1-MLC', name: 'Qwen 2.5 1.5B', description: 'Multilingual (~800MB)' },
    { id: 'SmolLM2-1.7B-Instruct-q4f32_1-MLC', name: 'SmolLM2 1.7B', description: 'Efficient (~900MB)' },
    { id: 'Phi-3.5-mini-instruct-q4f32_1-MLC', name: 'Phi 3.5 Mini', description: 'Microsoft model (~2GB)' },
  ],
};

export function AIProviderSelector() {
  const { ai, setAISettings } = useSettingsStore();
  const models = MODELS[ai.provider] || [];

  return (
    <Card>
      <CardHeader>
        <CardTitle>AI Settings</CardTitle>
        <CardDescription>
          Configure AI provider and model for conversations
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* AI Provider */}
        <div className="space-y-2">
          <label className="text-sm font-medium">AI Provider</label>
          <Select
            value={ai.provider}
            onValueChange={(value) => {
              setAISettings({ provider: value });
              // Reset model when provider changes
              const newModels = MODELS[value] || [];
              if (newModels.length > 0) {
                setAISettings({ model: newModels[0].id });
              }
            }}
          >
            <SelectTrigger>
              <SelectValue placeholder="Select AI provider" />
            </SelectTrigger>
            <SelectContent>
              {AI_PROVIDERS.map((provider) => (
                <SelectItem key={provider.id} value={provider.id}>
                  <div className="flex items-center gap-2">
                    <span>{provider.name}</span>
                    <Badge variant="outline" className="text-xs">
                      {provider.type}
                    </Badge>
                  </div>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <p className="text-xs text-muted-foreground">
            {AI_PROVIDERS.find(p => p.id === ai.provider)?.description}
          </p>
        </div>

        {/* Model selection */}
        {models.length > 0 && (
          <div className="space-y-2">
            <label className="text-sm font-medium">Model</label>
            <Select
              value={ai.model}
              onValueChange={(value) => setAISettings({ model: value })}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select model" />
              </SelectTrigger>
              <SelectContent>
                {models.map((model) => (
                  <SelectItem key={model.id} value={model.id}>
                    <div className="flex flex-col">
                      <span>{model.name}</span>
                      <span className="text-xs text-muted-foreground">
                        {model.description}
                      </span>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        )}

        {/* Cost estimate */}
        <div className="p-3 bg-muted rounded-lg">
          <h4 className="text-sm font-medium mb-1">Estimated Cost</h4>
          <p className="text-xs text-muted-foreground">
            {ai.provider === 'ollama' || ai.provider === 'webllm' 
              ? 'Free - runs locally on your device'
              : ai.model === 'gpt-4o-mini' 
                ? '~$0.15 per 1M input tokens, ~$0.60 per 1M output tokens'
                : ai.model === 'gpt-4o' 
                  ? '~$2.50 per 1M input tokens, ~$10 per 1M output tokens'
                  : ai.model === 'gpt-4-turbo' 
                    ? '~$10 per 1M input tokens, ~$30 per 1M output tokens'
                    : ai.model === 'gpt-3.5-turbo' 
                      ? '~$0.50 per 1M input tokens, ~$1.50 per 1M output tokens'
                      : 'Varies by model'}
          </p>
        </div>
      </CardContent>
    </Card>
  );
}
