'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { useSettingsStore } from '@/stores/settingsStore';

// CURSOR: TranslationPopup - Shows translation for selected text
// Allows saving words to vocabulary

interface TranslationPopupProps {
  text: string;
  children: React.ReactNode;
  chatId?: string;
  onSaveToVocabulary?: (word: string, translation: string) => void;
}

interface TranslationResult {
  translatedText: string;
  detectedSourceLang?: string;
}

export function TranslationPopup({ 
  text, 
  children, 
  chatId,
  onSaveToVocabulary 
}: TranslationPopupProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [translation, setTranslation] = useState<TranslationResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);
  
  const language = useSettingsStore((state) => state.language);

  const fetchTranslation = async () => {
    if (translation) return; // Already fetched
    
    setIsLoading(true);
    setError(null);
    
    try {
      const response = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text,
          targetLanguage: language.mother, // Translate to user's native language
          sourceLanguage: language.learning,
        }),
      });

      if (!response.ok) {
        throw new Error('Translation failed');
      }

      const data = await response.json();
      setTranslation({
        translatedText: data.translation.translatedText,
        detectedSourceLang: data.translation.detectedSourceLang,
      });
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Translation failed');
    } finally {
      setIsLoading(false);
    }
  };

  const handleOpenChange = (open: boolean) => {
    setIsOpen(open);
    if (open && !translation) {
      fetchTranslation();
    }
  };

  const handleSave = async () => {
    if (!translation) return;
    
    try {
      const response = await fetch('/api/vocabulary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          word: text,
          translation: translation.translatedText,
          context: chatId,
        }),
      });

      if (response.ok) {
        setSaved(true);
        onSaveToVocabulary?.(text, translation.translatedText);
      }
    } catch (err) {
      console.error('Failed to save to vocabulary:', err);
    }
  };

  return (
    <Popover open={isOpen} onOpenChange={handleOpenChange}>
      <PopoverTrigger asChild>
        {children}
      </PopoverTrigger>
      <PopoverContent className="w-64 p-3" align="start">
        <div className="space-y-2">
          {/* Original text */}
          <div>
            <span className="text-xs text-muted-foreground">Original:</span>
            <p className="font-medium">{text}</p>
          </div>

          {/* Translation */}
          <div>
            <span className="text-xs text-muted-foreground">Translation:</span>
            {isLoading ? (
              <p className="text-sm text-muted-foreground animate-pulse">Translating...</p>
            ) : error ? (
              <p className="text-sm text-destructive">{error}</p>
            ) : translation ? (
              <p className="font-medium">{translation.translatedText}</p>
            ) : null}
          </div>

          {/* Save button */}
          {translation && (
            <Button
              size="sm"
              variant={saved ? 'secondary' : 'default'}
              onClick={handleSave}
              disabled={saved}
              className="w-full mt-2"
            >
              {saved ? 'Saved!' : 'Save to Vocabulary'}
            </Button>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}
