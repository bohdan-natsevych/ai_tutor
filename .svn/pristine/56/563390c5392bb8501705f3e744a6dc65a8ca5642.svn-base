import type { TTSProvider, TTSOptions, Voice, TTSProviderStatus } from '../types';

// Kokoro TTS Provider (Local WebGPU)
// Uses kokoro-js library for high-quality local TTS

export class KokoroProvider implements TTSProvider {
  id = 'kokoro';
  name = 'Kokoro TTS (Local)';
  type = 'local' as const;
  voices: Voice[] = [
    // American English voices
    { id: 'af_heart', name: 'Heart (American Female)', language: 'en', dialect: 'american', gender: 'female' },
    { id: 'am_adam', name: 'Adam (American Male)', language: 'en', dialect: 'american', gender: 'male' },
    // British English voices
    { id: 'bf_emma', name: 'Emma (British Female)', language: 'en', dialect: 'british', gender: 'female' },
    { id: 'bm_george', name: 'George (British Male)', language: 'en', dialect: 'british', gender: 'male' },
  ];

  private kokoro: unknown = null;
  private status: TTSProviderStatus = {
    initialized: false,
    loading: false,
  };

  async initialize(): Promise<void> {
    // CURSOR: Skip if already initialized or currently loading
    if (this.status.initialized) {
      return;
    }
    if (this.status.loading) {
      // Already loading, wait for it to complete by polling
      return new Promise((resolve) => {
        const checkStatus = () => {
          if (!this.status.loading) {
            resolve();
          } else {
            setTimeout(checkStatus, 100);
          }
        };
        checkStatus();
      });
    }

    if (typeof window === 'undefined') {
      this.status = {
        initialized: false,
        loading: false,
        error: 'Kokoro TTS requires browser environment',
      };
      return;
    }

    // Check WebGPU support
    const gpu = (navigator as Navigator & { gpu?: unknown }).gpu;
    if (!gpu) {
      this.status = {
        initialized: false,
        loading: false,
        error: 'WebGPU not supported in this browser',
      };
      return;
    }

    this.status.loading = true;
    this.status.progress = 0;

    try {
      // Dynamically import kokoro-js to avoid SSR issues
      const { KokoroTTS } = await import('kokoro-js');
      
      // Initialize Kokoro TTS
      this.kokoro = await KokoroTTS.from_pretrained('onnx-community/Kokoro-82M-v1.0-ONNX', {
        dtype: 'fp32',
        device: 'webgpu',
        progress_callback: (progress: unknown) => {
          const p = progress as { progress?: number };
          if (p.progress !== undefined) {
            this.status.progress = Math.round(p.progress * 100);
          }
        },
      });

      this.status = {
        initialized: true,
        loading: false,
        progress: 100,
      };
    } catch (error) {
      this.status = {
        initialized: false,
        loading: false,
        error: error instanceof Error ? error.message : 'Failed to initialize Kokoro TTS',
      };
    }
  }

  async synthesize(text: string, options: TTSOptions): Promise<ArrayBuffer> {
    if (!this.kokoro) {
      throw new Error('Kokoro TTS not initialized');
    }

    const kokoroInstance = this.kokoro as {
      generate: (text: string, options: { voice: string; speed: number }) => Promise<{ toWav: () => Uint8Array }>;
    };

    // CURSOR: Log speed to verify it's being passed correctly
    console.log('[Kokoro TTS] Generating speech with speed:', options.speed);

    // Generate audio using Kokoro
    const audio = await kokoroInstance.generate(text, {
      voice: options.voice,
      speed: options.speed,
    });

    // Convert to WAV ArrayBuffer
    const wavData = audio.toWav();
    return new Uint8Array(wavData).buffer as ArrayBuffer;
  }

  getVoices(): Voice[] {
    return this.voices;
  }

  async isAvailable(): Promise<boolean> {
    if (typeof window === 'undefined') return false;
    
    const gpu = (navigator as Navigator & { gpu?: { requestAdapter: () => Promise<unknown> } }).gpu;
    if (!gpu) return false;
    
    try {
      const adapter = await gpu.requestAdapter();
      return adapter !== null;
    } catch {
      return false;
    }
  }

  getStatus(): TTSProviderStatus {
    return this.status;
  }

  // CURSOR: Cleanup WebGPU resources
  cleanup(): void {
    this.kokoro = null;
    this.status = {
      initialized: false,
      loading: false,
    };
  }
}

// Export singleton instance
export const kokoroProvider = new KokoroProvider();
